openapi: 3.0.3
info:
  title: Miru Backend-Agent API
  description: The API between the Miru Backend and the Agent; for internal use only
  version: 0.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: https://staging.api.mirurobotics.com/{audience}/{version}
    description: Staging
    variables:
      audience:
        default: agent
        enum:
          - agent
      version:
        default: v1
        enum:
          - v1
  - url: https://uat.api.mirurobotics.com/{audience}/{version}
    description: UAT
    variables:
      audience:
        default: agent
        enum:
          - agent
      version:
        default: v1
        enum:
          - v1
  - url: https://api.mirurobotics.com/{audience}/{version}
    description: Production
    variables:
      audience:
        default: agent
        enum:
          - agent
      version:
        default: v1
        enum:
          - v1
security:
  - ClerkAuth: []
paths:
  /version:
    get:
      tags:
        - Version
      summary: Get
      description: Retrieve the version information of the application.
      operationId: getVersion
      responses:
        '200':
          description: Successfully retrieved the release.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Version'
  /deployments:
    get:
      tags:
        - Deployments
      summary: List deployments
      operationId: listDeployments
      parameters:
        - $ref: '#/components/parameters/offset'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/deployment_list_expansions'
        - $ref: '#/components/parameters/deployment_search_activity_status'
      responses:
        '200':
          description: Successfully listed the deployments.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeploymentList'
  /deployments/{deployment_id}:
    patch:
      tags:
        - Deployments
      summary: Update a deployment
      operationId: updateDeployment
      parameters:
        - $ref: '#/components/parameters/deployment_id'
        - $ref: '#/components/parameters/deployment_expansions'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDeploymentRequest'
      responses:
        '200':
          description: Successfully updated the deployment.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Deployment'
  /devices/{device_id}:
    patch:
      tags:
        - Devices
      summary: Update a device by agent
      operationId: updateDeviceByAgent
      parameters:
        - $ref: '#/components/parameters/device_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateDeviceFromAgentRequest'
      responses:
        '200':
          description: Successfully updated the device.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
  /devices/{device_id}/activate:
    post:
      tags:
        - Devices
      summary: Activate a device
      operationId: activateDevice
      parameters:
        - $ref: '#/components/parameters/device_id'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivateDeviceRequest'
      responses:
        '200':
          description: Successfully activated the device.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Device'
  /devices/{device_id}/issue_token:
    post:
      tags:
        - Devices
      summary: Issue a device token
      operationId: issueDeviceToken
      parameters:
        - $ref: '#/components/parameters/device_id'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IssueDeviceTokenRequest'
      responses:
        '200':
          description: Successfully issued the device token.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
  /cmd/devices/{device_id}/sync:
    get:
      tags:
        - MQTT
      parameters:
        - name: device_id
          in: path
          required: true
          schema:
            type: string
            example: dvc_123
      summary: Trigger a device sync
      operationId: syncDevice
      responses:
        '200':
          description: Triggered a device sync.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncDevice'
  /cmd/devices/{device_id}/ping:
    get:
      tags:
        - MQTT
      parameters:
        - name: device_id
          in: path
          required: true
          schema:
            type: string
            example: dvc_123
      summary: Ping a device
      operationId: devicePing
      responses:
        '200':
          description: Ping a device.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ping'
  /resp/devices/{device_id}/pong:
    get:
      tags:
        - MQTT
      parameters:
        - name: device_id
          in: path
          required: true
          schema:
            type: string
            example: dvc_123
      summary: Ping device response
      operationId: devicePong
      responses:
        '200':
          description: Ping response.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pong'
components:
  securitySchemes:
    ClerkAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    APIVersion:
      type: string
      enum:
        - $API_VERSION$
      x-enum-varnames:
        - API_VERSION
      x-stainless-const: true
    APIGitCommit:
      type: string
      enum:
        - $API_GIT_COMMIT$
      x-enum-varnames:
        - API_GIT_COMMIT
      x-stainless-const: true
    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/Error'
    Version:
      title: Version
      type: object
      required:
        - version
        - git_commit
        - api_version
        - api_git_commit
        - go_version
        - build_date
        - os
        - arch
      properties:
        version:
          type: string
          description: The version of the application.
          example: v1.0.0
        git_commit:
          type: string
          description: The git commit of the application.
          example: a1b2c3d4
        api_version:
          type: string
          description: The API version of the application.
          example: v1.0.0
        api_git_commit:
          type: string
          description: The git commit of the API.
          example: a1b2c3d4
        go_version:
          type: string
          description: The version of Go.
          example: go1.20.0
        build_date:
          type: string
          format: date-time
          description: The build date of the application.
          example: '2025-01-01T00:00:00Z'
        os:
          type: string
          description: The operating system of the application.
          example: linux
        arch:
          type: string
          description: The architecture of the application.
          example: aarch64
    DeploymentListExpansion:
      type: string
      enum:
        - total_count
        - release
        - config_instances
      x-enum-varnames:
        - DEPLOYMENT_LIST_EXPAND_TOTAL_COUNT
        - DEPLOYMENT_LIST_EXPAND_RELEASE
        - DEPLOYMENT_LIST_EXPAND_CONFIG_INSTANCES
    DeploymentActivityStatus:
      type: string
      description: |
        Last known activity state of the deployment.
        - Drifted: device's configurations have drifted since this deployment was staged, and the deployment needs to be reviewed before it can be deployed
        - Staged: is ready to be deployed
        - Queued: the deployment's config instances are waiting to be received by the device; will be deployed as soon as the device is online
        - Deployed: the deployment's config instances are currently available for consumption on the device
        - Archived: the deployment is available for historical reference but cannot be deployed and is not active on the device
      enum:
        - drifted
        - staged
        - queued
        - deployed
        - archived
      x-enum-varnames:
        - DEPLOYMENT_ACTIVITY_STATUS_DRIFTED
        - DEPLOYMENT_ACTIVITY_STATUS_STAGED
        - DEPLOYMENT_ACTIVITY_STATUS_QUEUED
        - DEPLOYMENT_ACTIVITY_STATUS_DEPLOYED
        - DEPLOYMENT_ACTIVITY_STATUS_ARCHIVED
    PaginatedList:
      title: Paginated List
      type: object
      required:
        - object
        - total_count
        - limit
        - offset
        - has_more
      properties:
        object:
          type: string
          enum:
            - list
          example: list
          x-stainless-const: true
        total_count:
          type: integer
          format: int64
          description: The total number of items in the list. By default the total count is not returned. The total count must be expanded (using expand=total_count) to get the total number of items in the list.
        limit:
          type: integer
          description: The maximum number of items to return. A limit of 15 with an offset of 0 returns items 1-15.
          default: 10
          minimum: 1
          maximum: 100
        offset:
          type: integer
          description: The offset of the items to return. An offset of 10 with a limit of 10 returns items 11-20.
          default: 0
          minimum: 0
        has_more:
          type: boolean
          description: True if there are more items in the list to return. False if there are no more items to return.
          example: false
    DeploymentStatus:
      type: string
      description: |
        This status merges the 'activity_status' and 'error_status' fields, with error states taking precedence over activity states when errors are present. For example, if the activity status is 'deployed' but the error status is 'failed', the status is 'failed'. However, if the error status is 'none' and the activity status is 'deployed', the status is 'deployed'.
      enum:
        - drifted
        - staged
        - queued
        - deployed
        - archived
        - failed
        - retrying
      x-enum-varnames:
        - DEPLOYMENT_STATUS_DRIFTED
        - DEPLOYMENT_STATUS_STAGED
        - DEPLOYMENT_STATUS_QUEUED
        - DEPLOYMENT_STATUS_DEPLOYED
        - DEPLOYMENT_STATUS_ARCHIVED
        - DEPLOYMENT_STATUS_FAILED
        - DEPLOYMENT_STATUS_RETRYING
    DeploymentErrorStatus:
      type: string
      description: |
        Last known error state of the deployment.
        - None: no errors
        - Retrying: an error has been encountered and the agent is retrying to reach the target status
        - Failed: a fatal error has been encountered; the deployment is archived and (if deployed) removed from the device
      enum:
        - none
        - failed
        - retrying
      x-enum-varnames:
        - DEPLOYMENT_ERROR_STATUS_NONE
        - DEPLOYMENT_ERROR_STATUS_FAILED
        - DEPLOYMENT_ERROR_STATUS_RETRYING
    DeploymentTargetStatus:
      type: string
      description: |
        Desired state of the deployment.
        - Staged: is ready to be deployed
        - Deployed: all config instances part of the deployment are available for consumption on the device
        - Archived: the deployment is available for historical reference but cannot be deployed and is not active on the device
      enum:
        - staged
        - deployed
        - archived
      x-enum-varnames:
        - DEPLOYMENT_TARGET_STATUS_STAGED
        - DEPLOYMENT_TARGET_STATUS_DEPLOYED
        - DEPLOYMENT_TARGET_STATUS_ARCHIVED
    BaseDeployment:
      title: Base Deployment
      type: object
      required:
        - object
        - id
        - description
        - status
        - activity_status
        - error_status
        - target_status
        - device_id
        - release_id
        - created_at
        - updated_at
      properties:
        object:
          type: string
          enum:
            - deployment
          example: deployment
          x-stainless-const: true
        id:
          type: string
          example: dpl_123
          description: ID of the deployment.
        description:
          type: string
          example: Deployment for the motion control config instance
          description: The description of the deployment.
        status:
          $ref: '#/components/schemas/DeploymentStatus'
        activity_status:
          $ref: '#/components/schemas/DeploymentActivityStatus'
        error_status:
          $ref: '#/components/schemas/DeploymentErrorStatus'
        target_status:
          $ref: '#/components/schemas/DeploymentTargetStatus'
        device_id:
          type: string
          example: dvc_123
          description: ID of the device.
        release_id:
          type: string
          example: v1.0.0
          description: The version of the release.
        created_at:
          type: string
          format: date-time
          example: '2024-01-01T00:00:00Z'
          description: Timestamp of when the device release was created.
        updated_at:
          type: string
          format: date-time
          example: '2024-01-01T00:00:00Z'
          description: Timestamp of when the device release was last updated.
    BaseRelease:
      title: Base Release
      type: object
      required:
        - object
        - id
        - version
        - created_at
        - updated_at
      properties:
        object:
          type: string
          enum:
            - release
          example: release
          x-stainless-const: true
        id:
          type: string
          example: rls_123
          description: ID of the release.
        version:
          type: string
          example: v1.0.0
          description: The version of the release.
        created_at:
          type: string
          format: date-time
          example: '2024-01-01T00:00:00Z'
          description: Timestamp of when the release was created.
        updated_at:
          type: string
          format: date-time
          example: '2024-01-01T00:00:00Z'
          description: Timestamp of when the release was last updated.
    Release:
      title: Release
      allOf:
        - $ref: '#/components/schemas/BaseRelease'
    BaseConfigInstance:
      title: Base Config Instance
      type: object
      required:
        - object
        - id
        - config_type_name
        - filepath
        - created_at
        - config_schema_id
        - config_type_id
      properties:
        object:
          type: string
          enum:
            - config_instance
          example: config_instance
          x-stainless-const: true
        id:
          type: string
          example: cfg_inst_123
          description: ID of the config instance.
        config_type_name:
          type: string
          example: Motion Control
          description: The name of the config type.
        filepath:
          type: string
          example: /v1/motion-control.json
          description: The file path to deploy the config instance relative to `/srv/miru/config_instances`. `v1/motion-control.json` would deploy to `/srv/miru/config_instances/v1/motion-control.json`.
        created_at:
          type: string
          format: date-time
          example: '2021-01-01T00:00:00Z'
          description: The timestamp of when the config instance was created.
        config_schema_id:
          type: string
          example: cfg_sch_123
          description: ID of the config schema which the config instance must adhere to.
        config_type_id:
          type: string
          example: cfg_type_123
          description: ID of the config type which the config instance (and its schema) is a part of.
    BaseConfigType:
      title: Config Type
      type: object
      required:
        - object
        - id
        - name
        - slug
        - created_at
        - updated_at
      properties:
        object:
          type: string
          enum:
            - config_type
          example: config_type
          x-stainless-const: true
        id:
          type: string
          example: cfg_123
          description: ID of the config type.
        name:
          type: string
          example: My Config Type
          description: Name of the config type.
        slug:
          type: string
          example: my-config-type
          description: An immutable, code-friendly name for the config type.
        created_at:
          type: string
          format: date-time
          example: '2021-01-01T00:00:00Z'
          description: Timestamp of when the config type was created.
        updated_at:
          type: string
          format: date-time
          example: '2021-01-01T00:00:00Z'
          description: Timestamp of when the config type was last updated.
    ConfigType:
      title: Config Type
      allOf:
        - $ref: '#/components/schemas/BaseConfigType'
    ConfigInstance:
      title: Config Instance
      allOf:
        - $ref: '#/components/schemas/BaseConfigInstance'
        - type: object
          properties:
            config_type:
              allOf:
                - $ref: '#/components/schemas/ConfigType'
              description: Expand the config type using 'expand=config_type' in the query string.
              example: null
            content:
              type: object
              description: The configuration values associated with the config instance. Expand the content using 'expand=content' in the query string.
              example:
                enable_autonomy: true
                enable_remote_control: false
                max_payload_kg: 8.5
                preferred_speed_mode: normal
                emergency_stop_sensitivity: 0.9
                telemetry:
                  upload_interval_sec: 45
                  heartbeat_interval_sec: 15
    Deployment:
      title: Deployment
      allOf:
        - $ref: '#/components/schemas/BaseDeployment'
        - type: object
          properties:
            release:
              allOf:
                - $ref: '#/components/schemas/Release'
              example: null
              description: Expand the release using 'expand=release' in the query string.
            config_instances:
              type: array
              items:
                $ref: '#/components/schemas/ConfigInstance'
              description: Expand the config instances using 'expand=config_instances' in the query string.
    DeploymentList:
      title: Deployment List
      allOf:
        - $ref: '#/components/schemas/PaginatedList'
        - type: object
          required:
            - data
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Deployment'
    DeploymentExpansion:
      type: string
      enum:
        - release
        - config_instances
      x-enum-varnames:
        - DEPLOYMENT_EXPAND_RELEASE
        - DEPLOYMENT_EXPAND_CONFIG_INSTANCES
    UpdateDeploymentRequest:
      title: Update Deployment Request
      type: object
      properties:
        activity_status:
          allOf:
            - $ref: '#/components/schemas/DeploymentActivityStatus'
        error_status:
          allOf:
            - $ref: '#/components/schemas/DeploymentErrorStatus'
    UpdateDeviceFromAgentRequest:
      title: Update Device From Agent Request
      type: object
      properties:
        agent_version:
          type: string
          description: The version of the agent the device is running
          example: v1.0.0
    DeviceStatus:
      type: string
      description: |
        The status of the device.
        - Inactive: The miru agent has not yet been installed / authenticated
        - Activating: The miru agent is currently being installed / authenticated (should only last for a few seconds)
        - Online: The miru agent has successfully pinged the server within the last 60 seconds.
        - Offline: The miru agent has not successfully pinged the server within the last 60 seconds (e.g. network issues, device is powered off, etc.)
      enum:
        - inactive
        - activating
        - online
        - offline
      x-enum-varnames:
        - DEVICE_STATUS_INACTIVE
        - DEVICE_STATUS_ACTIVATING
        - DEVICE_STATUS_ONLINE
        - DEVICE_STATUS_OFFLINE
    BaseDevice:
      title: Base Device
      type: object
      required:
        - object
        - id
        - name
        - status
        - last_connected_at
        - last_disconnected_at
        - created_at
        - updated_at
      properties:
        object:
          type: string
          enum:
            - device
          example: device
          x-stainless-const: true
        id:
          type: string
          example: dvc_123
          description: ID of the device.
        name:
          type: string
          example: My Device
          description: Name of the device.
        status:
          $ref: '#/components/schemas/DeviceStatus'
        last_connected_at:
          type: string
          format: date-time
          example: '2021-01-01T00:00:00Z'
          nullable: true
          description: Timestamp of when the device was last made an initial connection (this is not the same as the last time the device was seen).
        last_disconnected_at:
          type: string
          format: date-time
          example: '2021-01-01T00:00:00Z'
          nullable: true
          description: Timestamp of when the device was last disconnected (this is not the same as the last time the device was seen).
        created_at:
          type: string
          format: date-time
          example: '2021-01-01T00:00:00Z'
          description: Timestamp of when the device was created.
        updated_at:
          type: string
          format: date-time
          example: '2021-01-01T00:00:00Z'
          description: Timestamp of when the device was last updated.
    Device:
      title: Device
      allOf:
        - $ref: '#/components/schemas/BaseDevice'
        - type: object
          required:
            - session_id
          properties:
            session_id:
              type: string
              example: dvc_sess_123
              description: Session ID of the device
    ActivateDeviceRequest:
      title: Activate Device Request
      type: object
      required:
        - public_key_pem
      properties:
        public_key_pem:
          type: string
          description: The public key in PEM format
          example: |
            -----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjVb+KEVBPIGDulBAuAUL\nT8PMvLW+VZ8aZ5p63/uHxM15fSPGnWZ4YtRHVed9gVRufrld3Pei7lP1LB88x6T0\nOPIQjMVXtx87bYSFFSrjqNg9yDUn17HDg7afehXoFuFi/q2QtTBKgOZqnPTRVHEM\nJqVjGCGb70AzpbcS6kdmlGjQY1R9uLbn8hREY+bUq5qgsnC2xfp5iioSYK8bkIUH\nexGybOcSLO21YIIsWoysBPppc1qqSo46L/xK+YjYkdMi3Qt0I07lS6FQk4lbUr6h\nHqRyCVEfUgqX4zy2ba0PHNImokltQfwrljfCZ/odCazCvqbrNptreQLoNVtN7NA4\nYQIDAQAB\n-----END PUBLIC KEY-----
        name:
          type: string
          example: Robot 1
        agent_version:
          type: string
          description: The version of the agent the device is running
          example: v1.0.0
    IssueDeviceClaims:
      title: Issue Device Claims
      type: object
      required:
        - device_id
        - nonce
        - expiration
      properties:
        device_id:
          type: string
          description: The device ID
          example: dvc_123
        nonce:
          type: string
          description: The nonce
        expiration:
          type: string
          format: date-time
          description: The expiration
          example: '2021-01-01T00:00:00Z'
    IssueDeviceTokenRequest:
      title: Issue Device Token Request
      type: object
      required:
        - claims
        - signature
      properties:
        claims:
          $ref: '#/components/schemas/IssueDeviceClaims'
        signature:
          type: string
          description: The signature
          example: MEUCIQDxCBtmFsd4Qohw+V6viyF8IpIjxA5oXNd64IUunURTTQIgcG80h+xGhY6kqtv9wHvU8M5aHfhXHwjiLB0OVZTPJSQ=
    TokenResponse:
      title: Token Response
      type: object
      required:
        - token
        - expires_at
      properties:
        token:
          type: string
          description: The token.
          example: eyJhbGciOiJ...
        expires_at:
          type: string
          format: date-time
          description: The expiration date and time of the token.
          example: '2025-01-01T00:00:00Z'
    SyncDevice:
      type: object
      required:
        - is_synced
      properties:
        is_synced:
          type: boolean
          example: true
    Ping:
      type: object
      required:
        - message_id
        - timestamp
      properties:
        message_id:
          type: string
          example: 123e4567-e89b-12d3-a456-426614174000
        timestamp:
          type: string
          format: date-time
          example: '2025-08-27T12:00:00Z'
    Pong:
      type: object
      required:
        - message_id
        - timestamp
        - version
      properties:
        message_id:
          type: string
          example: 123e4567-e89b-12d3-a456-426614174000
        timestamp:
          type: string
          format: date-time
          example: '2025-08-27T12:00:00Z'
    Error:
      type: object
      required:
        - code
        - params
        - message
      properties:
        code:
          type: string
          example: invalid_request
        params:
          type: object
          additionalProperties: true
          example:
            param1: value1
            param2: value2
        message:
          type: string
          example: This is a message for a user
  parameters:
    offset:
      name: offset
      in: query
      required: false
      description: The offset of the items to return. An offset of 10 with a limit of 10 returns items 11-20.
      schema:
        type: integer
        default: 0
        minimum: 0
    limit:
      name: limit
      in: query
      required: false
      description: The maximum number of items to return. A limit of 15 with an offset of 0 returns items 1-15.
      schema:
        type: integer
        default: 10
        minimum: 1
        maximum: 100
    deployment_list_expansions:
      name: expand
      in: query
      required: false
      schema:
        type: array
        items:
          $ref: '#/components/schemas/DeploymentListExpansion'
        description: The fields to expand in the deployments list.
    deployment_search_activity_status:
      name: activity_status
      in: query
      required: false
      style: form
      explode: false
      description: The deployment activity statuses to filter by.
      schema:
        type: array
        items:
          $ref: '#/components/schemas/DeploymentActivityStatus'
    deployment_id:
      name: deployment_id
      in: path
      required: true
      description: The unique identifier of the deployment.
      schema:
        type: string
        example: dpl_123
    deployment_expansions:
      name: expand
      in: query
      required: false
      schema:
        type: array
        items:
          $ref: '#/components/schemas/DeploymentExpansion'
        description: The fields to expand in the deployment.
    device_id:
      name: device_id
      in: path
      required: true
      description: The unique identifier of the device.
      schema:
        type: string
        example: dvc_123
